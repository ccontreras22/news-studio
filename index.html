<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify News Studio - Official Mix Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* LOCAL SPOTIFY MIX FONTS - Works on every computer */
        @font-face {
            font-family: 'SpotifyMix';
            src: url('fonts/SpotifyMixOffcWide-BlackItalic.ttf') format('truetype');
            font-weight: 900;
            font-style: italic;
            font-display: swap;
        }
        @font-face {
            font-family: 'SpotifyMix';
            src: url('fonts/SpotifyMix-Regular.otf') format('opentype');
            font-weight: 700;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SpotifyMix';
            src: url('fonts/SpotifyMix-Regular.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SpotifyMix';
            src: url('fonts/SpotifyMix-Light.otf') format('opentype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        /* SPOTIFY MIX THIN */
        @font-face {
            font-family: 'SpotifyMix';
            src: url('fonts/SpotifyMix-Thin.otf') format('opentype');
            font-weight: 100;
            font-style: normal;
            font-display: swap;
        }

        /* SPOTIFY MIX NARROW FONTS */
        @font-face {
            font-family: 'SpotifyMixNarrow';
            src: url('fonts/SpotifyMixNarrow-Regular.otf') format('opentype');
            font-weight: 400;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SpotifyMixNarrow';
            src: url('fonts/SpotifyMixNarrow-Light.otf') format('opentype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SpotifyMixNarrow';
            src: url('fonts/SpotifyMixNarrow-Medium.otf') format('opentype');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }
        @font-face {
            font-family: 'SpotifyMixNarrow';
            src: url('fonts/SpotifyMixNarrow-BoldItalic.otf') format('opentype');
            font-weight: 700;
            font-style: italic;
            font-display: swap;
        }

        :root { --spotify-green: #1DB954; }
        body {
            background-color: #0c0c0c; color: white;
            font-family: 'SpotifyMix', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; overflow: hidden;
        }

        /* --- TIPOGRAFÍA --- */
        .news-wide {
            font-family: 'SpotifyMix', sans-serif !important;
            font-weight: 900; font-style: italic; text-transform: uppercase;
            line-height: 0.88; display: block; width: 100%;
            letter-spacing: -0.03em; -webkit-font-smoothing: antialiased;
        }
        .news-mix-regular {
            font-family: 'SpotifyMix', sans-serif !important;
            font-weight: 700; line-height: 1.1; white-space: pre-line;
        }
        .news-mix-thin {
            font-family: 'SpotifyMix', sans-serif !important;
            font-weight: 400; line-height: 1.2; white-space: pre-line;
        }
        /* New font weight classes for Poster mode */
        .spotifymix-regular {
            font-family: 'SpotifyMix', sans-serif !important;
            font-weight: 400; line-height: 1.1; white-space: pre-line;
        }
        .spotifymix-thin {
            font-family: 'SpotifyMix', sans-serif !important;
            font-weight: 100; line-height: 1.2; white-space: pre-line;
        }
        .spotifymixnarrow-medium {
            font-family: 'SpotifyMixNarrow', sans-serif !important;
            font-weight: 500; line-height: 1.1; white-space: pre-line;
        }
        .spotifymixnarrow-light {
            font-family: 'SpotifyMixNarrow', sans-serif !important;
            font-weight: 300; line-height: 1.2; white-space: pre-line;
        }
        .txt-accent { color: var(--accent-color); }
        .txt-giant {
            font-size: 260%; line-height: 1; display: block;
            margin: -0.05em 0 0; padding-bottom: 0.2em;
            font-family: 'SpotifyMix', sans-serif !important;
            font-weight: 900; font-style: italic;
        }
        .txt-wide {
            font-family: 'SpotifyMix', sans-serif !important;
            font-weight: 900; font-style: italic; text-transform: uppercase; display: inline-block;
        }

        /* --- CANVAS --- */
        #canvas-wrapper {
            transition: transform 0.2s ease;
            transform-origin: center center;
            display: flex; align-items: center; justify-content: center;
        }
        .preview-container {
            position: relative; background: #000; box-sizing: border-box;
            display: flex; align-items: center; justify-content: center;
            padding: 4%; overflow: hidden;
            box-shadow: 0 40px 100px rgba(0,0,0,0.6); flex-shrink: 0;
        }
        .format-square  { width: 600px; height: 600px; }
        .format-portrait { width: 600px; height: 750px; }
        .format-story   { width: 450px; height: 800px; }
        .bg-layer { position: absolute; inset: 0; z-index: 0; }
        .grain-overlay {
            position: absolute; inset: 0; opacity: 0.18;
            background-image: url('https://www.transparenttextures.com/patterns/stardust.png');
            z-index: 5; pointer-events: none; mix-blend-mode: overlay;
        }
        .black-inner-box {
            background: #000; width: 100%; height: 100%;
            position: relative; z-index: 10; display: flex;
            flex-direction: column; padding: 2.8rem; box-sizing: border-box; overflow: hidden;
        }
        .spotify-bug { position: absolute; top: 1rem; left: 1rem; z-index: 50; }

        /* --- LISTA: items --- */
        .list-item-row {
            display: flex; align-items: center;
            gap: 0; flex-shrink: 0;
        }
        .list-item-photo {
            flex-shrink: 0;
            background-color: #1a1a1a;
            overflow: hidden;
            position: relative;
        }
        .list-item-photo img {
            width: 100%; height: 100%;
            object-fit: cover; object-position: center;
            display: block;
        }
        .list-item-text {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; padding-left: 1em;
            box-sizing: border-box;
        }
        .list-item-stat {
            font-family: 'SpotifyMix', sans-serif;
            font-weight: 900; font-style: italic;
            text-transform: uppercase; line-height: 0.9;
            -webkit-font-smoothing: antialiased;
        }
        .list-item-label {
            font-family: 'SpotifyMix', sans-serif;
            font-weight: 400; line-height: 1.2;
            text-transform: uppercase;
        }
        .list-divider {
            width: 100%; flex-shrink: 0;
            background: rgba(255,255,255,0.12);
            height: 1px;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: #121212; border-right: 1px solid #282828; height: 100vh;
        }
        .input-group label {
            display: block; font-size: 0.65rem; text-transform: uppercase;
            color: #888; margin-bottom: 0.4rem; font-weight: 800;
        }
        .sidebar-input {
            width: 100%; background: #252525; border: 1px solid #333;
            padding: 0.7rem; border-radius: 6px; color: white; font-size: 0.85rem; outline: none;
        }
        .sidebar-input:focus { border-color: var(--spotify-green); }
        .btn-export {
            background: #fff; color: #000; font-weight: 900; padding: 1rem;
            border-radius: 99px; text-transform: uppercase; letter-spacing: 0.05em; transition: 0.2s;
        }
        .btn-export:hover { background: var(--spotify-green); }
        .format-btn {
            background: #252525; border: 1px solid transparent; padding: 8px 4px;
            border-radius: 4px; font-size: 9px; font-weight: 900; text-transform: uppercase;
            color: #777; flex: 1; text-align: center;
        }
        .format-btn.active { border-color: var(--spotify-green); color: white; background: #2a2a2a; }
        .image-container-pro {
            flex: 1; width: 100%; background-size: cover; background-position: center;
            margin-top: auto; border: 1px solid rgba(255,255,255,0.05);
        }
        .tag-guide { font-size: 9px; color: #666; background: #1a1a1a; padding: 8px; border-radius: 4px; line-height: 1.4; }
        .tag-guide b { color: #aaa; }
        .main-viewer {
            height: 100vh; background: #080808; position: relative;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        input[type="range"] { accent-color: var(--spotify-green); width: 100%; }

        /* --- TABS --- */
        .mode-tab {
            flex: 1; padding: 7px 0; font-size: 9px; font-weight: 900;
            text-transform: uppercase; letter-spacing: 0.1em;
            color: #555; background: #1a1a1a; border: 1px solid #2a2a2a;
            border-radius: 5px; text-align: center; cursor: pointer; transition: 0.15s;
        }
        .mode-tab.active { color: #fff; background: #2a2a2a; border-color: var(--spotify-green); }

        /* --- LIST ITEM EDITOR --- */
        .list-item-editor {
            background: #1a1a1a; border: 1px solid #2a2a2a;
            border-radius: 8px; padding: 10px; position: relative;
        }
        .list-item-editor .item-num {
            font-size: 8px; font-weight: 900; text-transform: uppercase;
            color: #555; letter-spacing: 0.1em; margin-bottom: 8px;
        }
        .item-remove {
            position: absolute; top: 8px; right: 8px;
            font-size: 14px; color: #444; cursor: pointer; line-height: 1;
        }
        .item-remove:hover { color: #ff4444; }
        .btn-add-item {
            width: 100%; background: transparent; border: 1px dashed #333;
            color: #555; font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.1em; padding: 8px; border-radius: 6px; cursor: pointer; transition: 0.15s;
        }
        .btn-add-item:hover { border-color: var(--spotify-green); color: var(--spotify-green); }

        /* --- PIN PROTECTION --- */
        #pin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #pin-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        .pin-container {
            text-align: center;
            max-width: 400px;
            padding: 3rem;
            background: rgba(18, 18, 18, 0.95);
            border-radius: 24px;
            border: 1px solid #282828;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }
        .pin-logo {
            width: 80px;
            height: 80px;
            background: var(--spotify-green);
            border-radius: 50%;
            margin: 0 auto 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.4);
        }
        .pin-title {
            font-family: 'SpotifyMix', sans-serif;
            font-weight: 900;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .pin-subtitle {
            font-size: 0.875rem;
            color: #888;
            margin-bottom: 2rem;
        }
        .pin-input {
            width: 100%;
            background: #252525;
            border: 2px solid #333;
            padding: 1rem;
            border-radius: 12px;
            color: white;
            font-size: 1.25rem;
            text-align: center;
            letter-spacing: 0.5em;
            outline: none;
            font-family: 'SpotifyMix', monospace;
            transition: border-color 0.3s ease;
        }
        .pin-input:focus {
            border-color: var(--spotify-green);
        }
        .pin-input.error {
            border-color: #ff4444;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .pin-button {
            width: 100%;
            background: var(--spotify-green);
            color: #000;
            font-weight: 900;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 1rem;
            border: none;
            border-radius: 99px;
            margin-top: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .pin-button:hover {
            background: #1ed760;
            transform: scale(1.02);
        }
        .pin-button:active {
            transform: scale(0.98);
        }
        .pin-error {
            color: #ff4444;
            font-size: 0.75rem;
            margin-top: 0.5rem;
            min-height: 1rem;
            font-weight: 600;
        }
        #main-app {
            transition: opacity 0.5s ease;
        }
        #main-app.locked {
            filter: blur(20px);
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- PIN PROTECTION OVERLAY -->
    <div id="pin-overlay">
        <div class="pin-container">
            <div class="pin-logo">
                <svg width="45" height="45" viewBox="0 0 24 24" fill="black">
                    <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
                </svg>
            </div>
            <div class="pin-title">Acceso Restringido</div>
            <div class="pin-subtitle">Ingresa tu PIN para continuar</div>
            <input
                type="password"
                id="pin-input"
                class="pin-input"
                placeholder="••••"
                maxlength="4"
                inputmode="numeric"
                pattern="[0-9]*"
                autocomplete="off"
            >
            <div class="pin-error" id="pin-error"></div>
            <button class="pin-button" onclick="checkPin()">Acceder</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="flex flex-col md:flex-row h-screen overflow-hidden locked">

    <!-- SIDEBAR -->
    <aside class="sidebar w-full md:w-96 p-8 overflow-y-auto flex-shrink-0">
        <header class="flex items-center gap-3 mb-6">
            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="black"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.508 17.302c-.223.367-.703.483-1.07.26-2.917-1.783-6.59-2.185-10.915-1.196-.419.096-.842-.167-.938-.586-.096-.419.167-.842.586-.938 4.733-1.082 8.784-.622 12.077 1.391.367.223.483.703.26 1.07zm1.472-3.26c-.281.458-.881.602-1.339.321-3.34-2.053-8.432-2.646-12.382-1.447-.514.156-1.062-.132-1.218-.646-.156-.514.132-1.062.646-1.218 4.517-1.371 10.134-.71 13.973 1.649.458.281.602.881.32 1.339zm.126-3.413c-4.007-2.378-10.613-2.597-14.455-1.43-.615.187-1.263-.166-1.449-.781-.187-.615.166-1.263.781-1.449 4.417-1.34 11.696-1.084 16.3 1.646.554.329.739 1.042.41 1.597-.329.554-1.041.739-1.597.417h.01z"/></svg>
            </div>
            <h1 class="text-xs font-black uppercase tracking-[0.2em]">News Studio PRO</h1>
        </header>

        <!-- MODE TABS -->
        <div class="flex gap-2 mb-6">
            <button class="mode-tab active" id="tab-poster" onclick="setMode('poster')">Poster</button>
            <button class="mode-tab" id="tab-lista" onclick="setMode('lista')">List</button>
        </div>

        <!-- SHARED: palette + format -->
        <div id="shared-controls" class="space-y-4 mb-6">
            <div class="input-group">
                <label>Color Palette</label>
                <select id="in-palette" class="sidebar-input" onchange="render()">
                    <option value="0">Yellow 55 / Orange 180</option>
                    <option value="1">Blue Violet 55 / Red 155</option>
                    <option value="2">Pink 25 / Blue Violet 155</option>
                    <option value="3" selected>Violet 25 / Pumpkin 135</option>
                    <option value="4">Blue Desat 25 / Citric 186</option>
                    <option value="5">Green 25 / Aquamarine 180</option>
                    <option value="6">Green Blue 55 / Violet Pink 155</option>
                    <option value="7">Yellow Green Desat 55 / Orange 155</option>
                </select>
            </div>
            <div class="input-group">
                <label>Canvas Dimensions</label>
                <div class="flex gap-2">
                    <button onclick="setF('square')"  id="btn-square"  class="format-btn active">1:1</button>
                    <button onclick="setF('portrait')" id="btn-portrait" class="format-btn">4:5</button>
                    <button onclick="setF('story')"    id="btn-story"   class="format-btn">9:16</button>
                </div>
            </div>
        </div>

        <!-- POSTER MODE CONTROLS -->
        <div id="panel-poster" class="space-y-6">
            <div class="input-group">
                <label>Main Headline</label>
                <input type="text" id="in-title" class="sidebar-input" placeholder="HEADLINE" oninput="render()">
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-[9px] text-zinc-500 font-bold uppercase">Size</span>
                    <input type="range" id="in-title-size" min="30" max="150" value="75" oninput="render()">
                </div>
            </div>
            <div class="input-group">
                <label>Story Content</label>
                <textarea id="in-desc" rows="4" class="sidebar-input mb-3" placeholder="Use tags..." oninput="render()">Streams of [A]"Purple Rain"[/A] by Prince increased [G]+608%[/G] on Spotify.</textarea>
                <div class="tag-guide">
                    <b>[A]text[/A]</b> → Color Accent &nbsp;
                    <b>[G]text[/G]</b> → Giant &nbsp;
                    <b>[W]text[/W]</b> → Wide Italic
                </div>
                <div class="grid grid-cols-2 gap-3 mt-3">
                    <div><span class="text-[9px] text-zinc-500 font-bold uppercase">Base Size</span><input type="range" id="in-desc-size" min="12" max="42" value="20" oninput="render()"></div>
                    <div><span class="text-[9px] text-zinc-500 font-bold uppercase">Weight</span>
                        <select id="in-desc-variant" class="sidebar-input py-1 text-[10px]" onchange="render()">
                            <option value="spotifymix-regular">SpotifyMix Regular</option>
                            <option value="spotifymix-thin">SpotifyMix Thin</option>
                            <option value="spotifymixnarrow-medium">SpotifyMixNarrow Medium</option>
                            <option value="spotifymixnarrow-light">SpotifyMixNarrow Light</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="input-group flex items-center justify-between bg-zinc-800/50 p-3 rounded-lg">
                <label class="!mb-0">Include Photograph</label>
                <input type="checkbox" id="in-use-img" checked onchange="toggleImgUI()" class="w-4 h-4 accent-green-500">
            </div>
            <div id="img-controls" class="space-y-4">
                <div class="input-group">
                    <label>Image File</label>
                    <input type="file" id="in-img" class="sidebar-input" accept="image/*" onchange="handleImg(event)">
                    <div class="flex items-center gap-2 mt-3">
                        <span class="text-[9px] text-zinc-500 font-bold uppercase">Vertical</span>
                        <input type="range" id="in-img-pos" min="0" max="100" value="50" oninput="render()">
                    </div>
                </div>
            </div>
        </div>

        <!-- LISTA MODE CONTROLS -->
        <div id="panel-lista" class="space-y-4" style="display:none;">
            <div class="input-group">
                <label>Intro Headline</label>
                <input type="text" id="li-title" class="sidebar-input" placeholder="TOP STREAMS THIS WEEK" value="TOP STREAMS THIS WEEK" oninput="render()">
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-[9px] text-zinc-500 font-bold uppercase">Size</span>
                    <input type="range" id="li-title-size" min="16" max="80" value="38" oninput="render()">
                </div>
            </div>
            <div class="input-group">
                <label>Intro Subtitle</label>
                <input type="text" id="li-subtitle" class="sidebar-input" placeholder="Spotify · 2024" value="Spotify · 2024" oninput="render()">
            </div>

            <div class="border-t border-zinc-800 pt-4">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[9px] text-zinc-500 font-bold uppercase">List Items (max 5)</span>
                </div>
                <div id="list-items-editor" class="space-y-3"></div>
                <button class="btn-add-item mt-3" onclick="addListItem()">+ Add Item</button>
            </div>

            <div class="input-group">
                <label>Stat Font Size</label>
                <input type="range" id="li-stat-size" min="18" max="60" value="36" oninput="render()">
            </div>
            <div class="input-group">
                <label>Label Font Size</label>
                <input type="range" id="li-label-size" min="8" max="24" value="13" oninput="render()">
            </div>
            <div class="input-group">
                <label>Photo Size</label>
                <input type="range" id="li-photo-size" min="40" max="130" value="72" oninput="render()">
            </div>
        </div>


        <button class="btn-export w-full mt-6" onclick="download()">Export PNG</button>
    </aside>

    <!-- PREVIEW -->
    <main class="flex-1 main-viewer p-8">
        <div id="canvas-wrapper">
            <div id="canvas" class="preview-container format-square">
                <div id="bg-layer" class="bg-layer"></div>
                <div class="grain-overlay"></div>
                <div class="black-inner-box">
                    <div class="spotify-bug text-zinc-400 opacity-95">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.508 17.302c-.223.367-.703.483-1.07.26-2.917-1.783-6.59-2.185-10.915-1.196-.419.096-.842-.167-.938-.586-.096-.419.167-.842.586-.938 4.733-1.082 8.784-.622 12.077 1.391.367.223.483.703.26 1.07zm1.472-3.26c-.281.458-.881.602-1.339.321-3.34-2.053-8.432-2.646-12.382-1.447-.514.156-1.062-.132-1.218-.646-.156-.514.132-1.062.646-1.218 4.517-1.371 10.134-.71 13.973 1.649.458.281.602.881.32 1.339zm.126-3.413c-4.007-2.378-10.613-2.597-14.455-1.43-.615.187-1.263-.166-1.449-.781-.187-.615.166-1.263.781-1.449 4.417-1.34 11.696-1.084 16.3 1.646.554.329.739 1.042.41 1.597-.329.554-1.041.739-1.597.417h.01z"/></svg>
                    </div>
                    <div id="render-target" class="flex-1 flex flex-col h-full overflow-hidden mt-10"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let format = 'square';
        let mode = 'poster';
        let imgSource = null;
        let currentScale = 1;

        let listItems = [
            { img: null, stat: '+1,195%', label: 'Purple Rain' },
            { img: null, stat: '+608%',   label: 'When Doves Cry' },
            { img: null, stat: '+412%',   label: 'Kiss' },
        ];

        const palettes = [
            { c1: '#594602', c2: '#ffd4c2' }, { c1: '#3c00e4', c2: '#fe9da7' },
            { c1: '#550635', c2: '#afb1ff' }, { c1: '#400073', c2: '#ff7439' },
            { c1: '#1d2b3a', c2: '#cff56a' }, { c1: '#073116', c2: '#91eeda' },
            { c1: '#035341', c2: '#e9a1dc' }, { c1: '#414d1e', c2: '#ffa178' }
        ];

        function setMode(m) {
            mode = m;
            document.getElementById('panel-poster').style.display = m === 'poster' ? '' : 'none';
            document.getElementById('panel-lista').style.display  = m === 'lista'  ? '' : 'none';
            document.getElementById('tab-poster').classList.toggle('active', m === 'poster');
            document.getElementById('tab-lista').classList.toggle('active',  m === 'lista');

            render();
        }

        function setF(f) {
            format = f;
            document.getElementById('canvas').className = `preview-container format-${f}`;
            document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${f}`).classList.add('active');
            autoScale();
            render();
        }

        function autoScale() {
            const viewer = document.querySelector('.main-viewer');
            const canvas = document.getElementById('canvas');
            const wrapper = document.getElementById('canvas-wrapper');
            if (!viewer || !canvas || !wrapper) return;
            const vW = viewer.clientWidth - 40;
            const vH = viewer.clientHeight - 40;
            currentScale = Math.min(vW / canvas.offsetWidth, vH / canvas.offsetHeight, 1);
            wrapper.style.transform = `scale(${currentScale})`;
        }
        window.addEventListener('resize', autoScale);

        function toggleImgUI() {
            document.getElementById('img-controls').style.display =
                document.getElementById('in-use-img').checked ? 'block' : 'none';
            render();
        }
        function handleImg(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => { imgSource = ev.target.result; render(); };
                reader.readAsDataURL(file);
            }
        }

        function buildListEditor() {
            const container = document.getElementById('list-items-editor');
            container.innerHTML = '';
            listItems.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'list-item-editor';
                div.innerHTML = `
                    <div class="item-num">Item ${i + 1}</div>
                    ${listItems.length > 1 ? `<span class="item-remove" onclick="removeListItem(${i})">×</span>` : ''}
                    <div class="space-y-2">
                        <div>
                            <label style="display:block;font-size:8px;color:#555;text-transform:uppercase;margin-bottom:3px;font-weight:800;">Photo</label>
                            <input type="file" accept="image/*" class="sidebar-input text-[10px] p-1"
                                onchange="handleListImg(event, ${i})">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label style="display:block;font-size:8px;color:#555;text-transform:uppercase;margin-bottom:3px;font-weight:800;">Stat / %</label>
                                <input type="text" class="sidebar-input text-[11px] p-1" value="${item.stat}"
                                    oninput="updateListItem(${i}, 'stat', this.value)">
                            </div>
                            <div>
                                <label style="display:block;font-size:8px;color:#555;text-transform:uppercase;margin-bottom:3px;font-weight:800;">Label</label>
                                <input type="text" class="sidebar-input text-[11px] p-1" value="${item.label}"
                                    oninput="updateListItem(${i}, 'label', this.value)">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addListItem() {
            if (listItems.length >= 5) return;
            listItems.push({ img: null, stat: '+000%', label: 'Artist Name' });
            buildListEditor();
            render();
        }

        function removeListItem(i) {
            listItems.splice(i, 1);
            buildListEditor();
            render();
        }

        function updateListItem(i, key, val) {
            listItems[i][key] = val;
            render();
        }

        function handleListImg(e, i) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => { listItems[i].img = ev.target.result; render(); };
            reader.readAsDataURL(file);
        }

        function render() {
            const pal = palettes[document.getElementById('in-palette').value];
            document.documentElement.style.setProperty('--accent-color', pal.c2);
            document.getElementById('bg-layer').style.background =
                `radial-gradient(at 0% 0%, ${pal.c1} 0%, transparent 70%),
                 radial-gradient(at 100% 100%, ${pal.c2} 0%, transparent 70%), ${pal.c1}`;
            if (mode === 'poster') renderPoster(pal);
            else renderLista(pal);
        }

        function renderPoster(pal) {
            const title       = document.getElementById('in-title').value || 'THE FINALE';
            const titleSize   = document.getElementById('in-title-size').value;
            const descRaw     = document.getElementById('in-desc').value;
            const descSize    = document.getElementById('in-desc-size').value;
            const descVariant = document.getElementById('in-desc-variant').value;
            const useImg      = document.getElementById('in-use-img').checked;
            const imgPos      = document.getElementById('in-img-pos').value;

            let descFormatted = descRaw
                .replace(/\[A\](.*?)\[\/A\]/g, `<span class="txt-accent">$1</span>`)
                .replace(/\[G\](.*?)\[\/G\]/g, `<span class="txt-giant">$1</span>`)
                .replace(/\[W\](.*?)\[\/W\]/g, `<span class="txt-wide">$1</span>`);

            const target = document.getElementById('render-target');
            const flexAlign = useImg ? 'justify-start' : 'justify-center text-center items-center';
            target.className = `flex-1 flex flex-col h-full overflow-hidden mt-8 ${flexAlign}`;
            target.innerHTML = `
                <div class="w-full" style="overflow:visible;">
                    <h1 class="news-wide" style="font-size:${titleSize}px;color:${pal.c2};">${title}</h1>
                </div>
                <div class="${descVariant} mt-3 mb-10 uppercase description-block"
                     style="font-size:${descSize}px;color:white;width:100%;">
                    ${descFormatted}
                </div>
                ${useImg ? (imgSource
                    ? `<div class="image-container-pro" style="background-image:url('${imgSource}');background-position:50% ${imgPos}%;"></div>`
                    : `<div class="flex-1 w-full bg-zinc-900/30 border border-zinc-800 flex items-center justify-center italic text-zinc-700 text-[10px] uppercase tracking-widest mt-auto">Upload an image</div>`)
                : ''}
            `;
        }

        function renderLista(pal) {
            const title      = document.getElementById('li-title').value.trim();
            const titleSize  = parseInt(document.getElementById('li-title-size').value);
            const subtitle   = document.getElementById('li-subtitle').value  || '';
            const statSize   = parseInt(document.getElementById('li-stat-size').value);
            const labelSize  = parseInt(document.getElementById('li-label-size').value);
            const photoSize  = parseInt(document.getElementById('li-photo-size').value);

            const target = document.getElementById('render-target');
            target.className = 'flex-1 flex flex-col h-full overflow-hidden mt-6';

            const headlineStyle = [
                `font-family:'SpotifyMix',sans-serif`,
                `font-weight:900`,`font-style:italic`,`text-transform:uppercase`,
                `letter-spacing:-0.03em`,`line-height:1.05`,`display:block`,
                `margin:0`,`padding:0`,`color:${pal.c2}`,`font-size:${titleSize}px`,
                `-webkit-font-smoothing:antialiased`,
            ].join(';');

            const subtitleStyle = [
                `font-family:'SpotifyMix',sans-serif`,
                `font-weight:400`,`line-height:1.2`,`text-transform:uppercase`,
                `color:white`,`font-size:${labelSize + 2}px`,
                `margin:${Math.round(titleSize * 0.18)}px 0 0 0`,`padding:0`,`display:block`,
            ].join(';');

            const headerGap = Math.round(titleSize * 0.6);
            let html = (title || subtitle) ? `
                <div style="margin-bottom:${headerGap}px; flex-shrink:0; display:block;">
                    ${title    ? `<span style="${headlineStyle}">${title}</span>` : ''}
                    ${subtitle ? `<span style="${subtitleStyle}">${subtitle}</span>` : ''}
                </div>
            ` : '';

            const rowPad = Math.round(photoSize * 0.14);
            const statStyle = [
                `font-family:'SpotifyMix',sans-serif`,
                `font-weight:900`,`font-style:italic`,`text-transform:uppercase`,
                `line-height:1.05`,`display:block`,`color:${pal.c2}`,
                `font-size:${statSize}px`,`-webkit-font-smoothing:antialiased`,
            ].join(';');

            const lblStyle = [
                `font-family:'SpotifyMix',sans-serif`,
                `font-weight:400`,`line-height:1.2`,`text-transform:uppercase`,
                `display:block`,`color:rgba(255,255,255,0.7)`,
                `font-size:${labelSize}px`,`margin-top:4px`,
            ].join(';');

            html += `<div style="flex:1;display:flex;flex-direction:column;justify-content:center;">`;

            listItems.forEach((item) => {
                const photoContent = item.img
                    ? `<img src="${item.img}" style="width:${photoSize}px;height:${photoSize}px;object-fit:cover;object-position:center;display:block;flex-shrink:0;">`
                    : `<div style="width:${photoSize}px;height:${photoSize}px;flex-shrink:0;background:#1a1a1a;display:flex;align-items:center;justify-content:center;">
                           <span style="font-size:${Math.round(photoSize*0.18)}px;color:#333;font-family:'SpotifyMix',sans-serif;text-transform:uppercase;letter-spacing:0.1em;">Photo</span>
                       </div>`;

                html += `
                    <div style="display:table;width:100%;padding:${rowPad}px 0;box-sizing:border-box;">
                        <div style="display:table-cell;vertical-align:middle;width:${photoSize}px;">${photoContent}</div>
                        <div style="display:table-cell;vertical-align:middle;padding-left:1em;">
                            <span style="${statStyle}">${item.stat}</span>
                            ${item.label ? `<span style="${lblStyle}">${item.label}</span>` : ''}
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            target.innerHTML = html;
        }


        async function download() {
            await document.fonts.ready;
            const canvas  = document.getElementById('canvas');
            const wrapper = document.getElementById('canvas-wrapper');

            // Reset transform and force multiple reflows
            wrapper.style.transform = 'none';
            canvas.offsetHeight; // Force reflow
            await new Promise(r => setTimeout(r, 100)); // Wait for render
            await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

            let savedHTML = null;

            if (mode === 'lista') {
                const target = document.getElementById('render-target');
                savedHTML = target.innerHTML;

                // Force another reflow before measuring
                target.offsetHeight;
                await new Promise(r => requestAnimationFrame(r));

                const targetRect = target.getBoundingClientRect();

                const measure = (el) => {
                    const r = el.getBoundingClientRect();
                    return {
                        top:    r.top    - targetRect.top,
                        left:   r.left   - targetRect.left,
                        width:  r.width,
                        height: r.height,
                    };
                };

                let absHTML = `<div style="position:relative;width:100%;height:100%;">`;

                // More specific selector for header block (first direct child with margin-bottom)
                const headerBlock = target.querySelector('div[style*="margin-bottom"]');
                if (headerBlock) {
                    const headerRect = measure(headerBlock);
                    Array.from(headerBlock.children).forEach(child => {
                        const cRect = measure(child);
                        // Copy computed styles for better accuracy
                        const computed = window.getComputedStyle(child);
                        absHTML += `<div style="position:absolute;top:${cRect.top}px;left:${cRect.left}px;width:${cRect.width}px;height:${cRect.height}px;">
                            ${child.outerHTML}
                        </div>`;
                    });
                }

                const rows = target.querySelectorAll('[style*="display:table"]');
                rows.forEach(row => {
                    const rowRect = measure(row);
                    const cells = row.querySelectorAll('[style*="display:table-cell"]');

                    cells.forEach(cell => {
                        const cellRect = measure(cell);
                        const img = cell.querySelector('img');

                        if (img) {
                            const iRect = measure(img);
                            absHTML += `<div style="position:absolute;top:${iRect.top}px;left:${iRect.left}px;width:${iRect.width}px;height:${iRect.height}px;overflow:hidden;">
                                <img src="${img.src}" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block;">
                            </div>`;
                        } else {
                            const spans = cell.querySelectorAll('span');

                            // Measure each span with forced reflow
                            const spanMeasures = Array.from(spans).map(s => {
                                s.offsetHeight; // Force reflow
                                return measure(s);
                            });

                            // Calculate total height including gaps
                            let totalH = spanMeasures.reduce((sum, sm) => sum + sm.height, 0);
                            if (spans.length > 1) totalH += (spans.length - 1) * 4;

                            // Calculate vertical centering based on actual row height
                            const vStart = rowRect.top + Math.round((rowRect.height - totalH) / 2);
                            const textLeft = spanMeasures.length > 0
                                ? spanMeasures[0].left
                                : cellRect.left + 16;

                            let cursor = vStart;
                            spans.forEach((s, si) => {
                                const sr = spanMeasures[si];
                                absHTML += `<div style="position:absolute;top:${cursor}px;left:${textLeft}px;width:${cellRect.width}px;height:${sr.height}px;">
                                    ${s.outerHTML}
                                </div>`;
                                cursor += sr.height + (si < spans.length - 1 ? 4 : 0);
                            });
                        }
                    });
                });

                absHTML += `</div>`;
                target.innerHTML = absHTML;

                // Force reflow and wait before capturing
                target.offsetHeight;
                await new Promise(r => setTimeout(r, 150));
                await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
            }

            try {
                const result = await html2canvas(canvas, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false,
                    width: canvas.offsetWidth,
                    height: canvas.offsetHeight,
                    onclone: (clonedDoc) => {
                        const clonedWrapper = clonedDoc.getElementById('canvas-wrapper');
                        if (clonedWrapper) {
                            clonedWrapper.style.transform = 'none';
                            clonedWrapper.style.display = 'block';
                        }

                        // Copy all computed styles for text elements in lista mode
                        if (mode === 'lista') {
                            // Copy header styles
                            const liveHeaders = document.querySelectorAll('[style*="font-weight:900"]');
                            const clonedHeaders = clonedDoc.querySelectorAll('[style*="font-weight:900"]');
                            liveHeaders.forEach((live, i) => {
                                const cloned = clonedHeaders[i];
                                if (!cloned) return;
                                const cs = window.getComputedStyle(live);
                                cloned.style.fontSize = cs.fontSize;
                                cloned.style.lineHeight = cs.lineHeight;
                                cloned.style.fontWeight = cs.fontWeight;
                                cloned.style.fontStyle = cs.fontStyle;
                                cloned.style.letterSpacing = cs.letterSpacing;
                            });

                            // Copy all span styles
                            const liveSpans = document.querySelectorAll('#render-target span');
                            const clonedSpans = clonedDoc.querySelectorAll('#render-target span');
                            liveSpans.forEach((live, i) => {
                                const cloned = clonedSpans[i];
                                if (!cloned) return;
                                const cs = window.getComputedStyle(live);
                                cloned.style.fontSize = cs.fontSize;
                                cloned.style.lineHeight = cs.lineHeight;
                                cloned.style.fontWeight = cs.fontWeight;
                                cloned.style.fontFamily = cs.fontFamily;
                                cloned.style.fontStyle = cs.fontStyle;
                            });
                        }

                        // Handle poster mode text elements
                        const liveGiants = document.querySelectorAll('.txt-giant');
                        const clonedGiants = clonedDoc.querySelectorAll('.txt-giant');
                        liveGiants.forEach((g, i) => {
                            const cs = window.getComputedStyle(g);
                            const el = clonedGiants[i];
                            if (!el) return;
                            el.style.display       = 'block';
                            el.style.lineHeight    = cs.lineHeight;
                            el.style.marginTop     = cs.marginTop;
                            el.style.marginBottom  = cs.marginBottom;
                            el.style.paddingBottom = cs.paddingBottom;
                            el.style.fontSize      = cs.fontSize;
                        });

                        clonedDoc.querySelectorAll('.news-wide').forEach((el, i) => {
                            const live = document.querySelectorAll('.news-wide')[i];
                            if (!live) return;
                            const cs = window.getComputedStyle(live);
                            el.style.lineHeight = cs.lineHeight;
                            el.style.fontSize = cs.fontSize;
                        });
                    }
                });

                const link = document.createElement('a');
                link.download = `spotify-news-${mode}-${format}-${Date.now()}.png`;
                link.href = result.toDataURL('image/png');
                link.click();
            } catch (err) {
                console.error('Export Error:', err);
            } finally {
                if (savedHTML !== null) {
                    document.getElementById('render-target').innerHTML = savedHTML;
                }
                wrapper.style.transform = `scale(${currentScale})`;
            }
        }

        buildListEditor();
        setTimeout(() => { autoScale(); render(); }, 500);

        // ==================== PIN PROTECTION ====================
        const CORRECT_PIN = '1234'; // CHANGE THIS TO YOUR DESIRED PIN

        function checkPin() {
            const input = document.getElementById('pin-input');
            const error = document.getElementById('pin-error');
            const overlay = document.getElementById('pin-overlay');
            const mainApp = document.getElementById('main-app');
            const enteredPin = input.value;

            if (enteredPin === CORRECT_PIN) {
                // Correct PIN
                error.textContent = '';
                input.classList.remove('error');
                overlay.classList.add('hidden');
                mainApp.classList.remove('locked');
                sessionStorage.setItem('spotify-news-studio-auth', 'true');
            } else {
                // Incorrect PIN
                error.textContent = 'PIN incorrecto. Inténtalo de nuevo.';
                input.classList.add('error');
                input.value = '';
                setTimeout(() => {
                    input.classList.remove('error');
                }, 500);
            }
        }

        // Allow Enter key to submit
        document.getElementById('pin-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPin();
            }
        });

        // Check if already authenticated in this session
        window.addEventListener('load', function() {
            if (sessionStorage.getItem('spotify-news-studio-auth') === 'true') {
                document.getElementById('pin-overlay').classList.add('hidden');
                document.getElementById('main-app').classList.remove('locked');
            }
        });

        // Only allow numbers in PIN input
        document.getElementById('pin-input').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
    </div> <!-- Close main-app -->
</body>
</html>
